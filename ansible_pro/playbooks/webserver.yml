---
- hosts: webserver
  become: true
  gather_facts: false
  # vars:
  #   packages:
  #       - apache2
  #       - libapache2-mod-wsgi-py3
  #       - python3-pip
  #       - python3-virtualenv
  tasks:
    - name: install apache2
      apt:
        name: "{{ item }}"
        state: present 
        update_cache: yes
      # loop: "{{ packages }}"
      loop:
        - apache2
        - libapache2-mod-wsgi-py3
        - python3-pip
        - python3-virtualenv
        - python3-mysqldb
      # loop_control:
      #   index_var: index
      #   # loop_var: package
      #   label: "{{ index }}"
    - name: ensure apache2 started
      service:
        name: apache2
        state: started
        enabled: yes

    - name: ensure mod_wsgi enabled
      community.general.apache2_module: 
        state: present
        name: wsgi
      notify: restart apache2

    - name: copy demo app source
      copy: 
        src: demo/app/
        dest: /var/www/demo/
        mode: 0755
      notify: restart apache2

    - name: copy apache virtual host config
      copy: 
        src: demo/demo.conf
        dest: /etc/apache2/sites-available
        mode: 0755
      notify: restart apache2

    - name: setup python env
      pip:
        requirements: /var/www/demo/requirements.txt
        virtualenv: /var/www/demo/.venv
      notify: restart apache2 

    - name: de-activate default apache site
      file:
        path: /etc/apache2/sites-enabled/000-default.conf
        state: absent
      notify: restart apache2

    - name: activate demo apache2 site
      file:
        src: /etc/apache2/sites-available/demo.conf
        dest: /etc/apache2/sites-enabled/demo.conf
        state: link
      notify: restart apache2

  handlers:
    - name: restart apache2
      service: 
        name: apache2
        state: restarted





